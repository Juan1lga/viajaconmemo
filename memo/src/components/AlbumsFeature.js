import React, { useEffect, useState, useCallback } from "react";import { Link, useParams, useNavigate } from "react-router-dom";import { assetsOrigin, getAlbums, createAlbumWithCover, getAlbumPhotos, uploadPhoto } from "../utils/api";import Lightbox from "./Lightbox";import { useToast } from "./ToastProvider";

export const AlbumCard = ({ album, photos = [] }) => { const cover = (album && album.coverUrl) ? album.coverUrl : (photos[0] ? (photos[0].url || `${assetsOrigin}${photos[0].imageUrl}`) : "/logo512.png?v=2"); return (<div className="album-card" style={{border:"1px solid #eee",borderRadius:"8px",overflow:"hidden",boxShadow:"0 4px 12px rgba(0,0,0,.08)",background:"#fff"}}> <Link to={`/albums/${album._id}`} style={{textDecoration:"none",color:"inherit"}}> <div style={{position:"relative",paddingTop:"56.25%",background:"#f7f7f7"}}> <img src={cover} alt={album.name} style={{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"cover"}} /> </div> <div style={{padding:"12px"}}> <h3 style={{margin:"0 0 8px",fontSize:"1.1rem"}}>{album.name}</h3> {photos && photos.length ? (<div style={{display:"flex",gap:"6px",flexWrap:"wrap"}}> {photos.slice(0,3).map((p) => { const src = p.url || `${assetsOrigin}${p.imageUrl}`; return <img key={p._id} src={src} alt={p.title || "Foto"} style={{width:"30%",aspectRatio:"1/1",objectFit:"cover",borderRadius:"4px"}}/>; })} </div>) : null} </div> </Link> </div>); };

export const AlbumsPage = () => { const [albums, setAlbums] = useState([]); const [name, setName] = useState(""); const [coverFile, setCoverFile] = useState(null); const [loading, setLoading] = useState(true); const [error, setError] = useState(""); const navigate = useNavigate(); const { showSuccess } = useToast(); const loadAlbums = async () => { try { const { data } = await getAlbums(); setAlbums(Array.isArray(data) ? data : []); } catch (e) { setError("No se pudieron cargar los álbumes"); } finally { setLoading(false); } }; useEffect(() => { loadAlbums(); }, []); const handleCreate = async (e) => { e.preventDefault(); if (!name.trim()) return; try { const data = await createAlbumWithCover(name, coverFile); const newAlbum = data?.album; if (newAlbum && newAlbum._id) { navigate(`/albums/${newAlbum._id}`); } else { await loadAlbums(); } showSuccess("Álbum creado exitosamente."); setName(""); setCoverFile(null); } catch (err) { const msg = err?.response?.data?.msg || "Error al crear el álbum"; setError(msg); } }; if (loading) return <div className="loading">Cargando álbumes...</div>; return (<div className="container" style={{padding:"1rem"}}> <h2 className="section-title">Álbumes</h2> <form onSubmit={handleCreate} style={{display:"flex",flexDirection:"column",gap:"12px",margin:"12px 0 20px",padding:"16px",border:"1px solid #eee",borderRadius:"8px"}}> <div> <label>Nombre del álbum</label> <input type="text" value={name} onChange={(e)=>setName(e.target.value)} placeholder="Ej: Viaje a la playa" required /> </div> <div> <label>Foto de portada (opcional)</label> <input type="file" accept="image/*" onChange={(e)=>setCoverFile(e.target.files[0])} /> </div> <button type="submit" className="btn primary" style={{alignSelf:"flex-start"}}>Crear Álbum</button> </form> {error && <div className="error-message" style={{marginBottom:"12px"}}>{error}</div>} {albums.length === 0 ? (<p>No hay álbumes aún.</p>) : (<div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(220px, 1fr))",gap:"12px"}}> {albums.map((a)=> <AlbumCard key={a._id} album={a} photos={[]} />)} </div>)} </div> ); };

export const AlbumDetailPage = () => { const { id } = useParams(); const [album, setAlbum] = useState(null); const [photos, setPhotos] = useState([]); const [loading, setLoading] = useState(true); const [error, setError] = useState(""); const [showUpload, setShowUpload] = useState(false); const [title, setTitle] = useState(""); const [description, setDescription] = useState(""); const [file, setFile] = useState(null); const [lightboxOpen, setLightboxOpen] = useState(false); const [lightboxIndex, setLightboxIndex] = useState(0); const { showSuccess } = useToast(); const openLightbox = (index) => { setLightboxIndex(index); setLightboxOpen(true); }; const load = useCallback(async () => { try { const { data: albumsData } = await getAlbums(); const found = (Array.isArray(albumsData) ? albumsData : []).find(a => a._id === id); setAlbum(found || null); const { data: photosData } = await getAlbumPhotos(id, { approved: true }); setPhotos(Array.isArray(photosData) ? photosData : []); } catch (e) { setError("No se pudo cargar el álbum"); } finally { setLoading(false); } }, [id]); useEffect(()=>{ load(); }, [load]); const handleUpload = async (e) => { e.preventDefault(); if (!file) return; try { const formData = new FormData(); formData.append("image", file); formData.append("title", title); formData.append("description", description); formData.append("album", id); await uploadPhoto(formData); showSuccess("Foto subida exitosamente. Pendiente de aprobación."); setTitle(""); setDescription(""); setFile(null); setShowUpload(false); await load(); } catch (err) { const msg = err?.response?.data?.msg || "Error al subir la foto"; setError(msg); } }; if (loading) return <div className="loading">Cargando álbum...</div>; if (!album) return <div className="error-message">Álbum no encontrado.</div>; return (<div className="container" style={{padding:"1rem"}}> <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"8px"}}> <h2 className="section-title" style={{margin:"0"}}>{album.name}</h2> <button className="btn-cta" onClick={()=>setShowUpload(v=>!v)}>{showUpload ? "Cerrar" : "Sube tu propia foto"}</button> </div> {error && <div className="error-message" style={{marginBottom:"12px"}}>{error}</div>} {showUpload && (<form onSubmit={handleUpload} style={{marginTop:"12px",padding:"12px",border:"1px solid #eee",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,.08)",background:"#fff",display:"grid",gap:"8px",gridTemplateColumns:"1fr 1fr"}}> <div style={{gridColumn:"1 / -1"}}> <label>Título</label> <input type="text" value={title} onChange={(e)=>setTitle(e.target.value)} placeholder="Título de la foto" required /> </div> <div> <label>Archivo</label> <input type="file" accept="image/*" onChange={(e)=>setFile(e.target.files[0])} required /> </div> <div> <label>Descripción</label> <textarea rows={3} value={description} onChange={(e)=>setDescription(e.target.value)} placeholder="Descripción (opcional)"></textarea> </div> <div style={{gridColumn:"1 / -1",display:"flex",gap:"8px"}}> <button type="submit" className="btn primary">Subir Foto</button> <button type="button" className="btn" onClick={()=>setShowUpload(false)}>Cancelar</button> </div> </form>)} {photos.length === 0 ? (<p style={{marginTop:"16px"}}>Aún no hay fotos aprobadas en este álbum.</p>) : (<div className="gallery-grid" style={{marginTop:"16px",display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(180px, 1fr))",gap:"10px"}}> {photos.map((p, i)=>{ const src = p.url || `${assetsOrigin}${p.imageUrl}`; return (<div key={p._id} className="gallery-item" style={{borderRadius:"6px",overflow:"hidden",boxShadow:"0 2px 8px rgba(0,0,0,.06)",cursor:"pointer"}} onClick={()=>openLightbox(i)}> <img src={src} alt={p.title || "Foto"} style={{width:"100%",aspectRatio:"1/1",objectFit:"cover"}} /> {p.title || p.description ? (<div className="meta" style={{padding:"6px 8px"}}> {p.title && <h4 style={{margin:"0 0 4px"}}>{p.title}</h4>} {p.description && <p style={{margin:0}}>{p.description}</p>} </div>) : null} </div>); })} </div>)} {lightboxOpen && (<Lightbox images={photos.map((p)=>({ src: p.url || `${assetsOrigin}${p.imageUrl}`, title: p.title, description: p.description }))} startIndex={lightboxIndex} onClose={()=>setLightboxOpen(false)} />)} </div> ); };

export const AlbumsPreview = () => { const [albums, setAlbums] = useState([]); const [preview, setPreview] = useState({}); const [loading, setLoading] = useState(true); const [error, setError] = useState(""); const load = useCallback(async () => { try { const { data } = await getAlbums(); const list = Array.isArray(data) ? data : []; setAlbums(list); const pairs = await Promise.all(list.map(async (a) => { try { const { data: photos } = await getAlbumPhotos(a._id, { approved: true }); return [a._id, Array.isArray(photos) ? photos.slice(0,3) : []]; } catch (_) { return [a._id, []]; } })); const map = {}; pairs.forEach(([id, ph]) => { map[id] = ph; }); setPreview(map); } catch (e) { setError("No se pudieron cargar los álbumes"); } finally { setLoading(false); } }, []); useEffect(()=>{ load(); }, [load]); if (loading) return <div className="loading">Cargando álbumes...</div>; if (error && !albums.length) return <div className="error-message">{error}</div>; if (!albums.length) return (<section id="albums" style={{margin:"20px 0"}}> <h2 className="section-title">Álbumes</h2> <div className="gallery-actions" style={{margin:"10px 0"}}><Link to="/albums" className="btn-cta">Crea tu álbum</Link></div> <p>No hay álbumes aún.</p> </section>); return (<section id="albums" style={{margin:"20px 0"}}> <h2 className="section-title">Álbumes</h2> <div className="gallery-actions" style={{margin:"10px 0"}}><Link to="/albums" className="btn-cta">Crea tu álbum</Link></div> <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(220px, 1fr))",gap:"12px"}}> {albums.map((a)=> <AlbumCard key={a._id} album={a} photos={preview[a._id] || []} />)} </div> </section>); };